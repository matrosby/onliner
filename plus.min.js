window.__sbg_plus_version="0.9.33";(function(){const t=[];function log(e,n=false){console[n?"error":"log"](`${e}`);t.push(`!!! ERROR !!! ${e}`)}window.onerror=function(e,n,i,o,r){t.push(`!!! ERROR !!! ${e} on ${i}:${o} (${r})`);return false};const e=["home","allLines","builder","undo","clear","route","copy","paste","help"];class Label{constructor(t){this.values=t}toString(){return this.values[window.__sbg_language]}}const n={save:new Label({ru:"Сохранить",en:"Save"}),close:new Label({ru:"Закрыть",en:"Close"}),ymaps:new Label({ru:"Яндекс Карты",en:"Yandex Maps"}),settings:{title:new Label({ru:"Настройки скриптов",en:"Scripts settings"}),button:new Label({ru:"Настройки",en:"Settings"}),version:new Label({ru:"Версия SBG+",en:"SBG+ Version"}),logs:new Label({ru:"Логи",en:"Logs"}),advanced:new Label({ru:"Все настройки",en:"All settings"})},toasts:{back:new Label({ru:'Нажмите кнопку "Назад" ещё раз\nдля выхода из игры',en:'Press "Back" button again to exit the game'}),logs:new Label({ru:"Логи скопированы в буфер обмена",en:"Logs has been copied into the clipboard"})},builder:{buttons:{home:{title:new Label({ru:"Я здесь",en:"Set home"}),description:new Label({ru:'устанавливает "домашнее местоположение", с которого игра всегда будет открываться в этом браузере',en:'sets "home location", which game will always start with in this browser'})},allLines:{title:new Label({ru:"Все линии",en:"All lines"}),description:new Label({ru:"включает/отключает показ реально существующих линий и регионов",en:"toggles currently existing lines and regions"})},builder:{title:new Label({ru:"Конструктор",en:"Builder"}),description:new Label({ru:"включает/отключает режим конструктора: нажатие на точку начинает новую линию, нажатие на другую точку - заканчивает линию",en:"toggles builder mode: click first point to start new line, click another point to finish the line"})},undo:{title:new Label({ru:"Отменить",en:"Undo"}),description:new Label({ru:"стирает последнюю построенную линию/регион",en:"removes last built line/region"})},clear:{title:new Label({ru:"Отменить всё",en:"Clear"}),description:new Label({ru:"стирает все построенные линии и регионы",en:"removes all build lines and regions"})},route:{title:new Label({ru:"Маршрут",en:"Print route"}),description:new Label({ru:"показывает все построенные линии, в виде списка в порядке постройки",en:"shows all built lines as a list in the order of building"})},copy:{title:new Label({ru:"Копировать",en:"Copy"}),description:new Label({ru:"(Ctrl-C) копирует все построенные линии в буфер обмена",en:"(Ctrl-C) copies all built lines into the clipboard"})},paste:{title:new Label({ru:"Вставить",en:"Paste"}),description:new Label({ru:"(Ctrl-V) вставляет ранее построенные линии из буфера обмена",en:"(Ctrl-V) pastes previously built lines from the clipboard"})},help:{title:new Label({ru:"Помощь",en:"Help"}),description:new Label({ru:"показывает инструкции",en:"shows instructions"})}},messages:{setHome:new Label({ru:"Всегда открывать SBG на текущем местоположении?",en:"Always open SBG using currently opened location?"}),deleteHome:new Label({ru:'Забыть "домашнее местоположение" SBG?',en:'Forget "home location"?'}),copied:new Label({ru:"Данные скопированы в буфер обмена",en:"Data has been copied into the clipboard"})},issues:{title:new Label({ru:"Известные ограничения и проблемы",en:"Known limitations and problems"}),list:[new Label({ru:"Не всегда рисуется линия, потому что если при нажатии мышкой сдвинуть карту хоть на миллиметр - карта думает, что её двигают, а не кликают, и никак не реагирует",en:"Lines are not always being drawn, because clicking mouse button when moving map even one pixel ahead will make the map treat this click as a moving action and do not react as expected"}),new Label({ru:"Если два раза нажать на точку - она остаётся оранжевой, даже если закончить линию",en:"Point leaves orange when clicking twice, even when line has been finished"}),new Label({ru:"Если нажать на точку, а потом подвинуть карту - она перестаёт быть оранжевой",en:"Orange point stops to be orange if move map"})]},help:{title:new Label({ru:"Конструктор",en:"Builder"}),buttons:new Label({ru:"Кнопки",en:"Buttons"})},validationErrors:{json:new Label({ru:"Текст должен быть валидным JSON-объектом",en:"Text should be a valid JSON object"}),empty:new Label({ru:"Ничего нет",en:"Nothing found"}),object:new Label({ru:"Данные должны быть объектом",en:"Data should be an object"}),objectProperties:new Label({ru:"Объект с данными должен содержать два объекта: 'points' и 'lines'",en:"Data object should contain two objects: 'points' and 'lines'"}),pointProperties:new Label({ru:"Каждый объект в 'points' должен содержать поля: 'guid' (string), 'title' (string) и 'coords' (object)",en:"Each object in 'points' should contain properties: 'guid' (string), 'title' (string) and 'coords' (object)"}),pointCoords:new Label({ru:"Каждый объект в 'points' должен содержать массив 'coords', из двух координат типа (number)",en:"Each object in 'points' should contain array 'coords' of two coordinates of type (number)"}),lines:new Label({ru:"Массив 'lines' должен состоять из массивов координат линий",en:"Array 'lines' should contain arrays of line coordinates"}),linesCoords:new Label({ru:"Каждый массив в 'lines' должен состоять из двух массивов координат точек",en:"Each array in 'lines' should contain two arrays of point coordinates"})}}};class Settings{constructor(){this.storageKey="sbg-plus-settings";try{const t=localStorage[this.storageKey];const e=JSON.parse(t);this.features=e.features}catch{this.features={}}}getFeature(t){return this.features[t]}setFeature(t,e){this.features[t]=e;return this}cleanupFeatures(){const t=Object.keys(a.keys);Object.keys(this.features).filter((e=>!t.includes(e))).forEach((t=>delete this.features[t]))}save(){const t={};t.features=this.features;const e=JSON.stringify(t);localStorage[this.storageKey]=e}}const i=new Settings;const o={scripts:{ru:"Скрипты",en:"Scripts"},base:{ru:"Основные настройки",en:"Basic settings"},cui:{ru:"Скрипт Николая",en:"Nicko script"},eui:{ru:"Скрипт Егора",en:"Egor script"},windows:{ru:"Окна",en:"Windows"},animations:{ru:"Анимации",en:"Animations"},toolbar:{ru:"Боковая панель",en:"Toolbar"},fire:{ru:"Атака",en:"Fire"},inventory:{ru:"Инвентарь",en:"Inventory"},leaderboard:{ru:"Лидеры",en:"Leaderboard"},info:{ru:"Информация о точке",en:"Point info"},draw:{ru:"Рисование",en:"Draw"},other:{ru:"Прочие настройки",en:"Other settings"},custom:{ru:"Мои настройки",en:"My settings"}};const r=["","pageLoad","cuiTransform","mapReady","fireClick"];class AnyFeatureBase{constructor(t,e,n){this.toggleValue=false;this.key=t;this.label=new Label(e);this.group=n.group;this.trigger=n.trigger;this.public=n.public||false;this.simple=n.simple||false;this.desktop=n.desktop||false;this.unchecked=n.unchecked||false;a.add(this)}isEnabled(){var t;return(t=this.isExplicitlyEnabled())!==null&&t!==void 0?t:this.isImplicitlyEnabled()}isExplicitlyEnabled(){return i.getFeature(this.key)}isImplicitlyEnabled(){return this.isAvailable()&&this.isIncluded(this.getPreset())&&!this.unchecked}isAvailable(){return(isMobile()||this.desktop)&&(this.public||this.getPreset()==="full"||localStorage["sbg-plus-test-mode"])}isSimple(){return this.simple}toggle(t=!this.toggleValue){const e=`data-feat-${this.key}`;this.toggleValue=t;if(t){document.body.setAttribute(e,"")}else{document.body.removeAttribute(e)}return t}isIncluded(t){const e=c[t]||c["base"];return e.length===0||e.includes(this)}getPreset(){return window.__sbg_preset}}class FeatureBase extends AnyFeatureBase{constructor(t,e,n){super(t.name,e,n)}setEnabled(t){i.setFeature(this.key,t);if(this.parent){const t=this.parent.children.filter((t=>!t.isEnabled()));a.check(this.parent,t.length===0)}}exec(t){if(!this.isEnabled()){log(`skipped ${this.func.name}`);return t}try{const e=this.getData(t);const n=this.func(e);this.toggle(true);log(`executed ${this.func.name}`);return n}catch(e){log(`failed ${this.func.name}: ${e.toString()}`,true);return t}}}class ParentFeature extends AnyFeatureBase{constructor(t,e,n){super(t,e,n);this.children=[];n.children.forEach((t=>{if(t.key===this.key){return}this.children.push(t);if(t instanceof FeatureBase){t.parent=this}}));this.propagate()}setEnabled(t){i.setFeature(this.key,t);this.propagate()}isEnabled(){var t;return(t=this.isExplicitlyEnabled())!==null&&t!==void 0?t:this.isImplicitlyEnabled()}propagate(){const t=i.getFeature(this.key);if(t!==undefined){this.children.map((e=>a.check(e,t)))}}}class Feature extends FeatureBase{constructor(t,e,n){super(t,e,n);this.func=t;this.requires=n.requires}getData(){if(this.requires){const t=this.requires();if(!t||typeof t==="object"&&"length"in t&&t.length===0){throw"requirement not met"}return t}return undefined}}window.Feature=Feature;class Transformer extends FeatureBase{constructor(t,e,n){super(t,e,n);this.func=t}getData(t){return t}}const s=["add","check"];class Features{constructor(){this.keys={};this.groups={};this.triggers={};this.listeners={};Object.keys(o).map((t=>this.groups[t]=[]));r.map((t=>this.triggers[t]=[]));s.map((t=>this.listeners[t]=[]))}on(t,e){this.listeners[t].push(e)}emit(t,...e){this.listeners[t].map((t=>t(...e)))}add(...[t]){this.keys[t.key]=t;this.groups[t.group].push(t);this.triggers[t.trigger].push(t);this.emit("add",t)}check(...t){this.emit("check",...t)}get(t){return this.keys[t.name]}}const a=new Features;let l="base";l="scripts";new Feature(loadCUI,{ru:"Скрипт Николая",en:"Nicko script"},{public:true,simple:true,group:l,trigger:""});new Feature(loadEUI,{ru:"Скрипт Егора",en:"Egor script"},{public:true,simple:true,group:l,trigger:"mapReady",desktop:true});new Feature(showBuilderPanel,{ru:"Конструктор (draw tools)",en:"Builder (draw tools)"},{public:true,simple:true,group:l,trigger:"mapReady",desktop:true});l="base";new Feature(enableBackButton,{ru:"Разрешить кнопку Back",en:"Enable back button"},{public:true,group:l,trigger:"mapReady"});new Feature(updateLangCacheAutomatically,{ru:"Автоматически обновлять кэш языка",en:"Update language cache automatically"},{public:true,group:l,trigger:"mapReady",desktop:true});new Feature(fixBlurryBackground,{ru:"Размывать фон за полупрозрачными окнами",en:"Fix blurry background in popups"},{public:true,group:l,trigger:"mapReady",desktop:true});new Feature(alignSettingsButtonsVertically,{ru:"Выровнять кнопки в настройках по ширине",en:"Align settings buttons vertically"},{public:true,group:l,trigger:"mapReady",desktop:true,requires:()=>$(".settings")});new Feature(fixCompass,{ru:"Починить компас",en:"Fix compass"},{public:true,group:l,trigger:"mapReady"});l="cui";new Transformer(disableClusters,{ru:"Отключить ромашку",en:"Disable clusters"},{public:true,simple:true,group:l,trigger:"cuiTransform"});new Transformer(disableAttackZoom,{ru:"Отключить изменение зума при атаке",en:"Disable changing zoom when attack"},{public:true,simple:true,group:l,trigger:"cuiTransform"});new Transformer(unlockCompassWhenRotateMap,{ru:"Разблокировать компас при вращении карты",en:"Unlock compass when rotate map"},{public:true,group:l,trigger:"cuiTransform"});new Transformer(alwaysClearInventory,{ru:"Авто-очищать инвентарь после каждого дискавера",en:"Auto-delete inventory after every discover"},{public:true,group:l,trigger:"cuiTransform"});new Feature(fixSortButton,{ru:"Исправить расположение кнопки сортировки",en:"Fix sort button z-index"},{public:true,group:l,trigger:"mapReady",requires:()=>$(".sbgcui_refs-sort-button")});l="eui";new Feature(centerIconsInGraphicalButtons,{ru:"Центрировать значки графических кнопок",en:"Center icons in graphical buttons"},{public:true,group:l,trigger:"mapReady"});new Feature(showReloadButtonInCompactMode,{ru:"Показать кнопку перезагрузки в компактном режиме",en:"Show reload button in compact mode"},{public:true,group:l,trigger:"mapReady"});l="windows";new Feature(hideCloseButton,{ru:"Спрятать кнопку закрытия, закрывать только по нажатию Back",en:"Hide close button, close only by pressing Back"},{group:l,trigger:"mapReady",requires:()=>$(".popup-close, #inventory__close")});l="animations";new Feature(disableCarouselAnimation,{ru:"Отключить анимацию карусели",en:"Disable carousel animations"},{public:true,group:l,trigger:"pageLoad",requires:()=>window.Splide});new Feature(disablePopupAnimation,{ru:"Отключить анимацию открытия и закрытия окон",en:"Disable open/close windows animation"},{public:true,group:l,trigger:"pageLoad",requires:()=>$(".popup")});new Feature(disableMapAnimation,{ru:"Отключить анимацию карты",en:"Disable map animation"},{public:true,group:l,trigger:"pageLoad"});new Feature(disableAttackButtonAnimation,{ru:"Отключить анимацию кнопки атаки",en:"Disable attack button animation"},{public:true,group:l,trigger:"pageLoad",requires:()=>$("#attack-menu")});new Feature(closeToastsAfter1sec,{ru:"Закрывать всплывающие сообщения через 1 секунду",en:"Close toasts after 1 second"},{public:true,group:l,trigger:"pageLoad",requires:()=>window.Toastify});new ParentFeature("disableAllAnimations",{ru:"Отключить все анимации",en:"Disable all animations"},{public:true,simple:true,group:l,trigger:"pageLoad",children:a.groups["animations"]});l="toolbar";new Feature(showQuickAutoSelectButton,{ru:"Показать кнопку для быстрого переключения автовыбора коров",en:"Show button for quick change auto-select settings"},{group:l,trigger:"mapReady",requires:()=>$(".sbgcui_toolbar")});new Feature(moveAllSidebarsRight,{ru:"Показывать все боковые панели справа",en:"Move all sidebars to the right"},{group:l,trigger:"mapReady",requires:()=>$(".sbgcui_toolbar-control")});new Feature(hideCUIToolbarToggleButton,{ru:"Скрыть кнопку закрытия панели скрипта Николая",en:"Hide CUI toolbar toggle button"},{public:true,group:l,trigger:"mapReady",requires:()=>$(".sbgcui_toolbar")});l="fire";new Feature(alwaysCenterAlignFireItemsCount,{ru:"Всегда выравнивать количество предметов по центру",en:"Always center align items count"},{group:l,trigger:"fireClick",requires:()=>$("#attack-slider")});new Feature(replaceHighlevelWarningWithIcon,{ru:"Заменить предупреждение про недостаточный уровень на значок поверх предмета",en:"Replace highlevel warning with an icon on top of the item"},{group:l,trigger:"fireClick",requires:()=>$("#attack-slider")});new Feature(joinFireButtons,{ru:"Объединить кнопку атаки и кнопку открытия панели атаки, закрывать панель кликом снаружи",en:"Join attack button and attack panel button, close panel by clicking outside"},{group:l,trigger:"fireClick",requires:()=>$("#attack-menu")});l="inventory";new Feature(increaseItemsFont,{ru:"Увеличить размер шрифта за счёт сокращения названий предметов",en:"Increase font size by shortening item names"},{group:l,trigger:"mapReady",requires:()=>$(".info.popup")});new Feature(showAutoDeleteSettingsButton,{ru:"Показать кнопку перехода к настройкам авто-удаления",en:"Show auto-delete settings button"},{group:l,trigger:"mapReady",requires:()=>$(".inventory.popup")});new Feature(restoreCUISort,{ru:"Заменить сортировку Егора на сортировку Николая",en:"Replace Egor sort with Nicko sort"},{public:true,simple:true,group:l,trigger:"mapReady",unchecked:true,requires:()=>$(".inventory__content")});new Feature(moveRerefenceButtonsDown,{ru:"Сдвинуть ниже кнопки направления сортировки и закрытия",en:"Move down sort direction button and close button"},{group:l,trigger:"mapReady",requires:()=>$(".inventory__content")});new Feature(hideManualClearButtons,{ru:"Спрятать кнопки ручного удаления предметов",en:"Hide manual clear buttons"},{group:l,trigger:"mapReady",requires:()=>$(".inventory__content")});new Feature(quickRecycleAllRefs,{ru:"Удалять все имеющиеся рефы от точки при нажатии кнопки удаления",en:"Recycle all existing refs of the point by clicking recycle button"},{group:l,trigger:"mapReady",requires:()=>$(".inventory__content")});l="leaderboard";new Feature(alwaysShowSelfStatistics,{ru:"Всегда показывать собственную статистику",en:"Always show self statistics"},{group:l,trigger:"mapReady",requires:()=>window.__sbg_function_drawLeaderboard,desktop:true});l="info";new Feature(makeInfoPopupSemiTransparent,{ru:"Сделать окно точки полупрозрачным",en:"Make info popup semi-transparent"},{group:l,trigger:"mapReady",requires:()=>$(".info.popup")});new Feature(alwaysShowSecondsForCoolDowns,{ru:"Всегда показывать отсчёт в секундах для кулдауна",en:"Always show seconds for cooldowns"},{group:l,trigger:"mapReady",requires:()=>$("#discover")});new Feature(enlargeCoreSlots,{ru:"Увеличить размер коров",en:"Enlarge core slots"},{group:l,trigger:"mapReady",requires:()=>$(".info.popup")});new Feature(alignCloseButtonVertically,{ru:"Выровнять кнопку закрытия по вертикали",en:"Align close button vertically"},{group:l,trigger:"mapReady",requires:()=>$(".info.popup > .popup-close")});new Feature(colorizeTimer,{ru:"Менять цвет таймера в зависимости от количества оставшихся дискаверов",en:"Change color of timer depending on remaining discovers"},{group:l,trigger:"mapReady",requires:()=>$("#discover")});new Feature(hideRepairButton,{ru:"Спрятать кнопку зарядки",en:"Hide repair button"},{group:l,trigger:"mapReady",requires:()=>$(".info.popup")});new Feature(replaceSwipeWithButton,{ru:"Показать кнопку для переключения между точками",en:"Show button to swipe between points"},{group:l,trigger:"mapReady",requires:()=>$(".sbgcui_swipe-cards-arrow")});new Feature(showFeatureToggles,{ru:"Показать кнопки для быстрого переключение между фичами",en:"Show buttons for quick toggling features"},{group:l,trigger:"mapReady"});l="draw";new Feature(selectTargetPointByClick,{ru:"Разрешить выбирать конечную точку кликом по ней",en:"Allow select target point by clicking it"},{group:l,trigger:"mapReady",requires:()=>window.__sbg_function_showInfo});new Feature(highlightSelectedTargetPoint,{ru:"Подсвечивать выбранную конечную точку",en:"Highlight selected target point"},{group:l,trigger:"mapReady",requires:()=>window.__sbg_variable_map});new Feature(matchDrawSliderButtons,{ru:"Расположить кнопку рисования ровно под кнопкой карусели рисования",en:"Place draw button exactly under draw carousel button"},{group:l,trigger:"mapReady",requires:()=>$(".draw-slider-wrp")});l="other";new Feature(enableOldWebViewCompatibility,{ru:"Включить совместимость со старыми webview",en:"Enable old web view compatibility"},{public:true,group:l,trigger:"mapReady",requires:()=>$(".popup.pp-center")});i.cleanupFeatures();const c={};c["base"]=[...a.groups.base];if(window.innerWidth>=800){c["base"].push(a.get(showBuilderPanel))}c["nicoscript"]=[...c["base"],...a.groups.cui,a.get(loadCUI)];c["egorscript"]=[...c["base"],...a.groups.eui,a.get(loadEUI)];c["allscripts"]=[...c["nicoscript"],...c["egorscript"],a.get(restoreCUISort)];c["full"]=[];class Layers{constructor(){this.layers={}}get(t){return this.layers[t]}set(t,e){this.layers[t]=e}}const u=new Layers;class Script{constructor(t){this.data=t}valueOf(){return this.data}replace(t,e){this.data=Script.replaceData(this.data,t,e);return this}replaceCUIBlock(t,e,n){var i;this.data=(i=this.data)===null||i===void 0?void 0:i.replace(new RegExp(`(\\/\\*\\s*${Script.regexEscape(t)}\\s*\\*\\/\n(\\s+)\\{\\s*\n\\s+)([\\s\\S]*?)(\n\\2\\})`),((t,i,o,r,s)=>i+Script.replaceData(r,e,n)+s));return this}removeCUIBlock(t){return this.replaceCUIBlock(t,/[\s\S]+/,"")}static regexEscape(t){return t.replace(/[.\-$^*?+\\/\\|[\]{}()]/g,"\\$&")}static replaceData(t,e,n){if(typeof t==="undefined"){log(`replace ${e}: data is undefined`,true);return t}if(e instanceof RegExp?t.match(e):t.includes(e)){if(typeof n==="string"){log(`replace '${e}' with a string: finished`);t=t.replace(e,n)}else{log(`replace '${e}' with callback: finished`);t=t.replace(e,n)}}else{log(`replace '${e}': not found`,true)}return t}transform(t){this.log("started",t);t(this);this.log("finished",t);return this}expose(t,{variables:e,functions:n}){if(!this.data){log("expose: data is undefined",true);return this}this.log("started",this.expose);this.replace(/((?:^|\n)\s*)(const|let)\s+(\w+)(?=[\s+,\n$])/g,((n,i,o,r)=>{var s,a;if((s=e===null||e===void 0?void 0:e.readable)===null||s===void 0?void 0:s.includes(r)){return`${i}window.${t}_variable_${r} = { get: () => ${r} };\n${i}${o} ${r}`}if((a=e===null||e===void 0?void 0:e.writable)===null||a===void 0?void 0:a.includes(r)){return`${i}window.${t}_variable_${r} = { get: () => ${r}, set: (value) => ${r} = value };\n${i}let ${r}`}return n}));this.data=this.data.replace(/(?:^|\n)\s*(async\s+)?function\s+(\w+)\s*\((.*?)\)\s*\{/g,((e,i,o,r)=>{var s,a,l;i=i||"";if((s=n===null||n===void 0?void 0:n.disabled)===null||s===void 0?void 0:s.includes(o)){return`${e} return;`}if((a=n===null||n===void 0?void 0:n.readable)===null||a===void 0?void 0:a.includes(o)){return`\nwindow.${t}_function_${o} = ${o};\n${e}`}if((l=n===null||n===void 0?void 0:n.writable)===null||l===void 0?void 0:l.includes(o)){return`${e}\n\treturn window.${t}_function_${o}(...arguments);\n}\nwindow.${t}_function_${o} = ${i}function(${r}) {`}return e}));this.log("finished",this.expose);return this}log(t,e){log(`${e.name}: ${t}, ${this.describeData()}`)}embed(){if(!this.data){log("embed failed, data is undefined",true);return}this.log("started",this.embed);Script.append((t=>t.textContent=this.data||""));this.log("finished",this.embed)}static loadScript(t){log(`load: started, src: ${t}`);Script.append((e=>e.src=t));log(`load: finished, src: ${t}`)}static append(t){const e=document.createElement("script");e.type="text/javascript";t(e);document.head.appendChild(e)}describeData(){return`data is ${typeof this.data==="string"?`${this.data.length} bytes length`:typeof this.data}`}}async function main(){if(location.pathname.startsWith("/login")){return}log("started");preventLoadingScript();enhanceEventListeners();window.__sbg_language=getLanguage();initFeedback();fixPermissionsCompatibility();await waitHTMLLoaded();initCSS();initSettings();window.__sbg_plus_modifyFeatures&&window.__sbg_plus_modifyFeatures(a);execFeatures("pageLoad");const t=await getNativeScript();await loadCUI(t);await wait((()=>window.__sbg_variable_map));initHome();initLayers();execFeatures("mapReady");execFireFeatures();log("finished")}async function copyLogs(){return navigator.clipboard.writeText(t.join("\n")).then((()=>showToast(n.toasts.logs,2e3)))}function showToast(t,e){window.Toastify&&window.Toastify({text:t.toString(),duration:e,forceDuration:true,gravity:"top",position:"right",className:"interaction-toast"}).showToast()}function addLayer(t,e){const n=new window.ol.source.Vector;const i=new window.ol.layer.Vector({source:n,className:`ol-layer__${t}`});i.setProperties({name:t,zIndex:u.get(e).getProperties().zIndex},true);window.__sbg_variable_map.get().addLayer(i);return i}function preventLoadingScript(){(t=>{Element.prototype.append=function(){if(arguments.length===0){return}if(arguments[0].src===getNativeScriptSrc()){return}t.apply(this,arguments)}})(Element.prototype.append);log("prevented loading script")}function getNativeScriptSrc(){return`https://sbg-game.ru/app/${isMobile()?"script.js":"intel.js"}`}function getCUIScriptSrc(){return"https://raw.githubusercontent.com/nicko-v/sbg-cui/main/index.js"}function getEUIScriptSrc(){return"https://github.com/egorantonov/sbg-enhanced/releases/latest/download/index.js"}function enhanceEventListeners(){((t,e)=>{function initEventListeners(t,e){t.__events=t.__events||{};t.__events[e]=t.__events[e]||{listeners:[]};return t}EventTarget.prototype.addEventListener=function(e,n){if(!n){return}const i=initEventListeners(this,e);if(i.__events[e].sealed){return}i.__events[e].listeners.push(n);t.apply(this,arguments)};EventTarget.prototype.removeEventListener=function(t,n){if(!n){return}const i=initEventListeners(this,t);const o=i.__events[t].listeners.indexOf(n);if(o!==-1){i.__events[t].listeners.splice(o,1)}e.apply(this,arguments)};EventTarget.prototype.getEventListeners=function(t){const e=initEventListeners(this,t);const n=[];for(const i of e.__events[t].listeners){if(!i){continue}n.push(i)}return n};EventTarget.prototype.getEventHandlers=function(t){const e=this;return e.getEventListeners(t).map((t=>"handleEvent"in t?t.handleEvent:t)).map((t=>t))};EventTarget.prototype.clearEventListeners=function(t,n){const i=initEventListeners(this,t);if(n){i.__events[t].sealed=true}for(const n of i.__events[t].listeners){e.apply(i,[t,n])}i.__events[t].listeners.splice(0)};EventTarget.prototype.addOnlyEventListener=function(e,n){if(!n){return}const i=initEventListeners(this,e);i.clearEventListeners(e,true);i.__events[e].listeners.push(n);t.apply(this,arguments)};EventTarget.prototype.addRepeatingEventListener=function(e,n,{repeats:i,timeout:o,tick:r=(()=>{}),filter:s=(()=>true),cancel:a=(()=>true)}){let l=0;t.call(this,e,(t=>{if(!s(t)){return}if(!a(t)){l=0;return}l++;if(l>=i){l=0;n(t);return}r(t,l);setTimeout((()=>{l=0}),o)}))}})(EventTarget.prototype.addEventListener,EventTarget.prototype.removeEventListener);log("enhanced event listeneres")}function getLanguage(){let t;try{t=JSON.parse(localStorage.settings).lang}catch{t=navigator.language}const e=["ru","uk","be","kk"].includes(t.split("-")[0])?"ru":"en";log(`detected language: ${e}`);return e}function initFeedback(){const t=1e3;const e=3;const n=2;document.addRepeatingEventListener("touchstart",(()=>copyLogs()),{repeats:n,timeout:t,filter:t=>t.touches.length===e})}function fixPermissionsCompatibility(){log(`userAgent: ${navigator.userAgent}`);if(typeof navigator.permissions==="undefined"){Object.defineProperty(navigator,"permissions",{value:{query:async()=>({state:"granted"})}})}if(typeof window.DeviceOrientationEvent.requestPermission!=="function"){window.DeviceOrientationEvent.requestPermission=async()=>"granted"}}async function loadCUI(t){if(!a.get(loadCUI).isEnabled()){log("CUI disabled; loading native script");t.embed();return}log("CUI enabled; loading CUI script");const e=await transformScript(getCUIScriptSrc(),"__sbg_cui_script",transformCUIScript);e.embed();await wait((()=>window.cuiStatus==="loaded"))}function transformCUIScript(t){t.transform(fixCompatibility);t.transform(fixGotoReference);t.transform(fixCUIDefaults);t.transform(fixCUIWarnings);t.transform(disableCUIPointNavigation);a.triggers["cuiTransform"].map((e=>{t=e.exec(t)}));return t}async function waitHTMLLoaded(){return new Promise((t=>{let e=false;function resolveOnce(){if(e){return}e=true;t();log("loaded DOM content")}document.addEventListener("DOMContentLoaded",resolveOnce);if(document.readyState!=="loading"){resolveOnce()}}))}async function getNativeScript(){return transformScript(getNativeScriptSrc(),"__sbg_script",transformNativeScript)}function isMobile(){if("maxTouchPoints"in navigator){return navigator["maxTouchPoints"]>0}else if("msMaxTouchPoints"in navigator){return navigator["msMaxTouchPoints"]>0}else if("orientation"in window){return true}else{return/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(navigator["userAgent"])}}async function transformScript(t,e,n){log(`transform script, src: ${t}`);const i=`${e}_original`;const o=`${e}_modified`;return fetch(t).then((t=>t.text())).then((t=>{let e=new Script(t);e.log("loaded",transformScript);window[i]=e.valueOf()||"";new Script(window[i]).log(`started as ${i}`,transformScript);e=n(e);window[o]=e.valueOf()||"";new Script(window[o]).log(`finished as ${o}`,transformScript);return e}))}function loadEUI(){window.cuiStatus="loaded";if(window.egorScript){window.egorScript()}else{Script.loadScript(getEUIScriptSrc())}}function transformNativeScript(t){return t.transform(includeYMaps).expose("__sbg",{variables:{readable:["draw_slider","FeatureStyles","is_dark","ItemTypes","LANG","map","TeamColors","temp_lines_source","units","VERSION"]},functions:{readable:["apiQuery","deleteInventoryItem","jquerypassargs","openProfile","takeUnits"],writable:["drawLeaderboard","manageDrawing","movePlayer","showInfo","timeToString"],disabled:!isMobile()&&localStorage["homeCoords"]?["movePlayer"]:undefined}})}function includeYMaps(t){const e="ymaps";let i;try{JSON.parse(localStorage.settings).base===e}catch{i=localStorage["sbg-plus-state-ymaps"]==="1"}const o=$('<input type="radio" />').attr("name","baselayer").val(e).prop("checked",i);const r=$("<span></span>").text(n.ymaps.toString());const s=$("<label></label>").addClass("layers-config__entry").append(o).append(" ").append(r);$('input[value="osm"]').parent().after(s);return t.replace("if (type == 'osm') {",`if (type == '${e}') { \n  theme = is_dark ? 'dark' : 'light';\n  source = new ol.source.XYZ({ url: \`https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}&scale=1&projection=web_mercator&theme=\${theme}&lang=\${window.__sbg_language}\` });\n} else if (type == 'osm') {\n`)}function setCSS(t){$("<style></style>").html(t).appendTo(document.body)}window.setCSS=setCSS;function initCSS(){setCSS(`\n\t\t\t.topleft-container,\n\t\t\t.bottom-container {\n\t\t\t\tz-index: 1;\n\t\t\t}\n\n\t\t\t.popup > .popup.sbg-plus-settings {\n\t\t\t\tleft: 0;\n\t\t\t\ttop: 0;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 100%;\n\t\t\t\ttransform: none;\n\t\t\t\tposition: absolute;\n\t\t\t\tpadding: 0.5em 1em;\n\t\t\t\tcolor: var(--text);\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-content {\n\t\t\t\twidth: 100%;\n\t\t\t\tgap: 0;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-section h4 {\n\t\t\t\tmargin: 1em 0 0.5em 0;\n\t\t\t\torder: -1;\n\t\t\t\tdisplay: none;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-section__item.simple ~ h4,\n\t\t\t.sbg-plus-settings.advanced .settings-section__item ~ h4 {\n\t\t\t\tdisplay: block;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-section__item {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-section__item.simple {\n\t\t\t\tdisplay: flex;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings.advanced .settings-section__item {\n\t\t\t\tdisplay: flex;\n\t\t\t}\n\n\t\t\t.sbg-plus-settings .settings-section__item span {\n\t\t\t\tflex-grow: 1;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 0.5em;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup:before {\n\t\t\t\t-webkit-backdrop-filter: blur(5px);\n\t\t\t\tbackdrop-filter: blur(5px);\n\t\t\t}\n\n\t\t\t.sbg-plus-popup textarea {\n\t\t\t\tdisplay: block;\n\t\t\t\twidth: 90vw;\n\t\t\t\tmax-width: 800px;\n\t\t\t\theight: 90vh;\n\t\t\t\toverflow: auto;\n\t\t\t\tpadding: 0.5em;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t\tfont-family: sans-serif;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup li {\n\t\t\t\tpadding: 0.25em 0;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup .buttons {\n\t\t\t\tdisplay: flex;\n\t\t\t\tgap: 0.5em;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup button {\n\t\t\t\twhite-space: nowrap;\n\t\t\t}\n\n\t\t\t.sbg-plus-popup .popup-button-secondary {\n\t\t\t\tfilter: grayscale(1);\n\t\t\t}\n\t\t`);log("initialized CSS")}function wait(t){return new Promise((e=>{const n=setInterval((()=>{const i=t();if(!i){return}clearInterval(n);e(i)}),10)}))}function initSettings(){new SettingsPopup;log("initialized settings")}function createPopup(t,e={roundClose:true}){var i;const o=$("<button></button>").addClass(e.roundClose?"popup-close":"popup-button-secondary").attr("data-round",e.roundClose?"true":null).html(e.roundClose?"&nbsp;✕&nbsp;":n.close.toString());const r=$("<div></div>").addClass("buttons").append(o);const s=$("<div></div>").addClass(`${t} sbg-plus-popup popup pp-center hidden`).append(r).appendTo("body");(i=o.get(0))===null||i===void 0?void 0:i.addOnlyEventListener("click",(function(){s.addClass("hidden")}));return s}function initHome(){if(isMobile()||!("homeCoords"in localStorage)){return}const t=JSON.parse(localStorage.homeCoords);window.__sbg_variable_map.get().getView().setCenter(t);log("initialized home location")}function initLayers(){for(const t of window.__sbg_variable_map.get().getAllLayers()){const e=t.getProperties().name;const n=!e?"base":e==="lines"&&u.get("lines")?"lines_temp":e;u.set(n,t)}log("initialized layers")}function execFeatures(t){a.triggers[t].map((t=>{if(t instanceof Feature){t.exec()}}));log(`executed all features on ${t}`)}function execFireFeatures(){let t=false;$("#attack-menu").on("click",(()=>{if(!t){t=true;execFeatures("fireClick")}}))}function fixCompatibility(t){(async()=>{log("fix CUI compatibility: wait window.cuiEmbedded");await wait((()=>window.cuiEmbedded));log("fix CUI compatibility: wait window.ol");await wait((()=>window.ol));log("fix CUI compatibility: set view animation duration");setViewAnimationDuration();log("fix CUI compatibility: subscribe to mapReady");window.addEventListener("mapReady",window.__sbg_cui_function_main);log("fix CUI compatibility: call olInjection");window.__sbg_cui_function_olInjection();log("fix CUI compatibility: replace defaults");replaceCUIDefaults();log("fix CUI compatibility: call loadMainScript");window.__sbg_cui_function_loadMainScript();log("fix CUI compatibility: loaded")})();t.log("replace",fixCompatibility);return t.replace("fetch('/app/script.js')","(async () => ({ text: async () => window.__sbg_script_modified }))()").replace("window.stop","// window.stop").replace("fetch('/app')","if (false) fetch('/')").replace(/$/,"window.cuiEmbedded = true").expose("__sbg_cui",{functions:{readable:["olInjection","loadMainScript","main"]}})}function setViewAnimationDuration(){if(typeof window.__sbg_plus_animation_duration==="number"){(t=>{window.ol.View.prototype.animate=function(...e){const n=e.map((t=>typeof t==="object"?{...t,duration:window.__sbg_plus_animation_duration}:t));t.call(this,...n)}})(window.ol.View.prototype.animate)}}function fixGotoReference(t){$(document).on("click",'a[href*="point="]',(t=>{var e;const n=(e=t.currentTarget.href.split("point=").pop())===null||e===void 0?void 0:e.split("&").shift();window.__sbg_function_showInfo(n);t.stopPropagation();return false}));t.log("replace",fixGotoReference);return t.replace("window.location.href = `/app/?point=${guid}`","window.__sbg_function_showInfo(guid)")}function fixCUIDefaults(t){return t.expose("__sbg_cui",{variables:{readable:["DEFAULT_CONFIG"]}})}function fixCUIWarnings(t){return t.replace("!viewport.content.match(yaRegexp)",'!viewport.content.match(yaRegexp) && navigator.userAgent.toLowerCase().includes("yabrowser")')}function disableCUIPointNavigation(t){return t.removeCUIBlock("Навигация к точке")}function replaceCUIDefaults(){window.__sbg_cui_variable_DEFAULT_CONFIG.get().mapFilters.sepia=0}function disableClusters(t){return t.replace("function mapClickHandler(event) {","function mapClickHandler(event) { event.isSilent = true;")}function disableAttackZoom(t){setCSS(`\n\t\t\t.sbgcui_lock_rotation[sbgcui_locked="true"]::before {\n\t\t\t\ttransition: none !important;\n\t\t\t}\n\t\t`);return t.replaceCUIBlock("Показ радиуса катализатора",/(?<=\n\s+)view\./g,(t=>`if (false) ${t}`))}function unlockCompassWhenRotateMap(t){return t.replaceCUIBlock("Вращение карты","if (latestTouchPoint == null) { return; }","if (latestTouchPoint == null) { if (isRotationLocked) { toggleRotationLock(event); touchStartHandler({...event, target: event.target, touches: [event.touches[0]], targetTouches: [event.targetTouches[0]] }); } return; }")}function alwaysClearInventory(t){return t.replace(/const MIN_FREE_SPACE = \d+/,"const MIN_FREE_SPACE = INVENTORY_LIMIT").replace("if (event.target == discoverButton) { clearInventory(); }","clearInventory();")}function disableCarouselAnimation(){window.Splide.defaults=window.Splide.defaults||{};window.Splide.defaults.speed=0}function disablePopupAnimation(){setCSS(`\n\t\t\t.popup {\n\t\t\t\ttransition: none !important;\n\t\t\t}\n\t\t`)}function disableMapAnimation(){window.__sbg_plus_animation_duration=0}function disableAttackButtonAnimation(){setCSS(`\n\t\t\t#attack-menu,\n\t\t\t#attack-menu:after {\n\t\t\t\ttransition: none !important;\n\t\t\t}\n\t\t`)}function closeToastsAfter1sec(){(t=>{window.Toastify.prototype.init=function(e){if(!e.forceDuration){e.duration=Math.min(e.duration||0,1e3)}t.call(this,e);return this};window.Toastify.prototype.init.prototype=t.prototype})(window.Toastify.prototype.init)}function enableBackButton(){const t=1e3;const e=[{hiddenClass:"hidden",selectors:[".popup",".draw-slider-wrp",".attack-slider-wrp"]},{hiddenClass:"sbgcui_hidden",selectors:[".sbgcui_settings"]}];function isPopupClosed(){let t=false;for(const{hiddenClass:n,selectors:i}of e){for(const e of i){for(const i of $(e).toArray()){if(!i.classList.contains(n)){i.classList.add(n);if(e===".draw-slider-wrp"){$("#draw-slider-close").trigger("click")}if(e===".attack-slider-wrp"){$("#attack-menu").removeClass("sbgcui_attack-menu-rotate")}t=true}}}}return t}document.addRepeatingEventListener("backbutton",(()=>location.replace("/window.close")),{repeats:2,timeout:t,tick:()=>showToast(n.toasts.back,t),cancel:()=>!isPopupClosed()})}function showBuilderPanel(){wait((()=>$(".topleft-container"))).then((t=>new Builder(t)))}function updateLangCacheAutomatically(){const t=setInterval((()=>{const e=window.__sbg_variable_VERSION.get();if(!e){return}clearInterval(t);const n="__sbg_current_version";const i=localStorage[n]||"unknown";localStorage[n]=e;if(i!==e){log(`update lang cache from ${i} version to ${e} version`);$("#lang-cache").trigger("click")}}),50)}function fixBlurryBackground(){setCSS(`\n\t\t\t.popup.pp-center {\n\t\t\t\tbackdrop-filter: none;\n\t\t\t\t-webkit-backdrop-filter: none;\n\t\t\t}\n\n\t\t\t.popup.pp-center:before {\n\t\t\t\tcontent: '';\n\t\t\t\tposition: absolute;\n\t\t\t\tleft: 0;\n\t\t\t\ttop: 0;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 100%;\n\t\t\t\t-webkit-backdrop-filter: blur(5px);\n\t\t\t\tbackdrop-filter: blur(5px);\n\t\t\t}\n\n\t\t\t.popup.pp-center > * {\n\t\t\t\tposition: relative;\n\t\t\t}\n\t\t`)}function alignSettingsButtonsVertically(){setCSS(`\n\t\t\t.settings-section__button {\n\t\t\t\tjustify-self: unset !important;\n\t\t\t}\n\n\t\t\t.settings-section__item {\n\t\t\t\tgrid-template-columns: 5fr 3fr;\n\t\t\t}\n\n\t\t\t.settings-section__item select {\n\t\t\t\ttext-align: center;\n\t\t\t}\n\t\t`)}function fixCompass(){const t=[...window.getEventHandlers("deviceorientation")];function triggerHandlers(e){t.map((t=>t({webkitCompassHeading:e})))}function deviceOrientationAbsoluteListener(t){if(!t.absolute||t.alpha==null||t.beta==null||t.gamma==null){return}const e=360;const n=-(t.alpha+t.beta*t.gamma/90)%e;window.removeEventListener("deviceorientation",deviceOrientationListener);triggerHandlers(n)}const deviceOrientationListener=t=>{const{webkitCompassHeading:e}=t;if(e!==null&&!isNaN(e)){triggerHandlers(e);window.removeEventListener("deviceorientationabsolute",deviceOrientationAbsoluteListener)}};function addListeners(){window.addEventListener("deviceorientationabsolute",deviceOrientationAbsoluteListener);window.addEventListener("deviceorientation",deviceOrientationListener)}window.DeviceOrientationEvent.requestPermission().then((t=>{if(t==="granted"){addListeners()}else{console.warn("DeviceOrientationEvent permission is not granted")}}))}function centerIconsInGraphicalButtons(){setCSS(`\n\t\t\t.material-symbols-outlined {\n\t\t\t\tline-height: 1 !important;\n\t\t\t}\n\t\t`)}function showReloadButtonInCompactMode(){setCSS(`\n\t\t\t.game-menu button.fa-solid-rotate:first-child:last-child {\n\t\t\t\theight: 2em;\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 0.75em;\n\t\t\t\tright: 0.75em;\n\t\t\t}\n\t\t`)}function alwaysCenterAlignFireItemsCount(){setCSS(`\n\t\t.splide__slide[data-rarity] .catalysers-list__amount {\n\t\t\tdisplay: block !important;\n\t\t}\n\t\t.splide__slide[data-rarity] .catalysers-list__amount:before {\n\t\t\tcontent: '';\n\t\t\tdisplay: inline-block;\n\t\t\tbackground: currentColor;\n\t\t\twidth: 1em;\n\t\t\theight: 1em;\n\t\t\tposition: absolute;\n\t\t\tright: 8px;\n\t\t\tfont-size: 0.85em;\n\t\t\tbottom: 5px;\n\t\t}\n\t\t`)}function replaceHighlevelWarningWithIcon(t){const e=t.height();setCSS(`\n\t\t\t#attack-slider {\n\t\t\t\tpadding: 4px 0;\n\t\t\t}\n\n\t\t\t.attack-slider-highlevel {\n\t\t\t\tpointer-events: none;\n\t\t\t\tfont-size: 36px;\n\t\t\t\twidth: 1px;\n\t\t\t\theight: ${e}px;\n\t\t\t\tmargin: -${e}px auto 0 auto;\n\t\t\t\tbackground: none;\n\t\t\t\tbackdrop-filter: none;\n\t\t\t\t-webkit-backdrop-filter: none;\n\t\t\t\ttext-align: center;\n\t\t\t\tdisplay: block;\n\t\t\t\tz-index: 1;\n\t\t\t}\n\t\t`);$(".attack-slider-highlevel").html("&#x20e0")}function joinFireButtons(t){const e=t.outerHeight();setCSS(`\n\t\t\t.attack-slider-wrp {\n\t\t\t\ttransition: none;\n\t\t\t\tposition: relative;\n\t\t\t\tz-index: 3;\n\t\t\t}\n\n\t\t\t.attack-slider-buttons {\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 100%;\n\t\t\t\tleft: 50%;\n\t\t\t\tpadding: 0;\n\t\t\t}\n\n\t\t\t#attack-slider-fire {\n\t\t\t\tmax-width: ${e}px;\n\t\t\t\theight: ${e}px;\n\t\t\t\topacity: 0;\n\t\t\t\tposition: relative;\n\t\t\t\tleft: -50%;\n\t\t\t}\n\n\t\t\t#attack-menu.sbgcui_attack-menu-rotate::after {\n\t\t\t\tbackground: var(--ingress-selection-color);\n\t\t\t}\n\n\t\t\t#attack-menu.sbgcui_attack-menu-rotate {\n\t\t\t\tborder-color: var(--ingress-selection-color);\n\t\t\t}\n\t\t`);$(window).on("click",(function(t){const e=t.target;if(e.id!=="attack-menu"&&$(".attack-slider-wrp.hidden").length===0&&$(e).parents(".attack-slider-wrp").length===0){$("#attack-menu").trigger("click")}}))}function showQuickAutoSelectButton(t){const e=JSON.parse(localStorage.sbgcui_config).autoSelect;const n=e.deploy==="max"?"fa-rotate-180":"";const i=$("<button></button>").addClass("fa fa-solid-arrow-down-short-wide").addClass(n).prependTo(t);i.on("click",(()=>{i.toggleClass("fa-rotate-180");const t=i.hasClass("fa-rotate-180");$('select[name="autoSelect_deploy"]').val(t?"max":"min");$('select[name="autoSelect_upgrade"]').val(t?"max":"min");$('form.sbgcui_settings button:contains("Сохранить")').trigger("click")}));setCSS(`\n\t\t\t.fa-rotate-180 {\n\t\t\t\ttransform: scale(-1, 1);\n\t\t\t}\n\t\t`)}function moveAllSidebarsRight(t){$(".ol-control").first().addClass("toolbar").prepend(t.children());setCSS(`\n\t\t\t.ol-control.toolbar {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t}\n\n\t\t\t.ol-control.toolbar #settings {\n\t\t\t\torder: 99;\n\t\t\t\tmargin-bottom: 0;\n\t\t\t}\n\n\t\t\t.sbgcui_toolbar {\n\t\t\t\tgap: 0;\n\t\t\t}\n\n\t\t\t.sbgcui_toolbar + button {\n\t\t\t\tmargin-bottom: 10px;\n\t\t\t}\n\n\t\t\t#toggle-follow {\n\t\t\t\tmargin-bottom: 10px;\n\t\t\t}\n\n\t\t\t.sbgcui_lock_rotation {\n\t\t\t\tmargin-top: 10px !important;\n\t\t\t}\n\t\t`)}function hideCUIToolbarToggleButton(){setCSS(`\n\t\t\t.sbgcui_toolbar {\n\t\t\t\tdisplay: flex !important;\n\t\t\t\tmargin-bottom: 10px;\n\t\t\t}\n\n\t\t\t.sbgcui_toolbar + button {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\t\t`)}function showAutoDeleteSettingsButton(t){$("<button></button>").text("Auto-delete").css({height:"40px"}).appendTo(t).on("click",(()=>{$("#inventory__close").trigger("click");$(".sbgcui_settings").removeClass("sbgcui_hidden");$('.sbgcui_settings-title:contains("Автоудаление")').trigger("click")}))}function moveRerefenceButtonsDown(){setCSS(`\n\t\t\t[data-feat-moveRerefenceButtonsDown] .inventory__controls {\n\t\t\t\theight: 0;\n\t\t\t\tmin-height: 0;\n\t\t\t\toverflow: hidden;\n\t\t\t}\n\n\t\t\t[data-feat-moveRerefenceButtonsDown] .inventory__content[data-tab="3"] ~ .inventory__controls > select {\n\t\t\t\tposition: fixed;\n\t\t\t\tright: 0;\n\t\t\t\tbottom: 51px;\n\t\t\t\theight: 40px;\n\t\t\t\tflex-grow: 0;\n\t\t\t\tflex-shrink: 0;\n\t\t\t\tmargin: 0 4px;\n\t\t\t\twidth: calc(100% - 8px);\n\t\t\t\ttext-align: center;\n\t\t\t}\n\n\t\t\t[data-feat-moveRerefenceButtonsDown] .inventory__content[data-tab="3"] ~ .inventory__controls > .sbgcui_refs-sort-button {\n\t\t\t\tborder-width: revert;\n\t\t\t\tborder-radius: 0;\n\t\t\t\tbottom: 51px;\n\t\t\t\tz-index: 2;\n\t\t\t\tright: 4px;\n\t\t\t\theight: 40px;\n\t\t\t\twidth: 40px;\n\t\t\t\tfont-size: 20px;\n\t\t\t}\n\n\t\t\t[data-feat-moveRerefenceButtonsDown] #inventory__close {\n\t\t\t\tbottom: 102px;\n\t\t\t}\n\n\t\t\t[data-feat-moveRerefenceButtonsDown] .inventory__content[data-tab="3"] {\n\t\t\t\tmargin-bottom: 41px;\n\t\t\t}\n\t\t`)}function hideManualClearButtons(){setCSS(`\n\t\t\t[data-feat-hideManualClearButtons] .inventory__controls {\n\t\t\t\theight: 0;\n\t\t\t\tmin-height: 0;\n\t\t\t\toverflow: hidden;\n\t\t\t}\n\n\t\t\t[data-feat-hideManualClearButtons] .inventory__content[data-tab="3"] ~ .inventory__controls > select {\n\t\t\t\tposition: fixed;\n\t\t\t\tright: 0;\n\t\t\t\tbottom: 51px;\n\t\t\t\theight: 40px;\n\t\t\t\tflex-grow: 0;\n\t\t\t\tflex-shrink: 0;\n\t\t\t\tmargin: 0 4px;\n\t\t\t\twidth: calc(100% - 8px);\n\t\t\t\ttext-align: center;\n\t\t\t}\n\n\t\t\t[data-feat-hideManualClearButtons] .inventory__content[data-tab="3"] ~ .inventory__controls > .sbgcui_refs-sort-button {\n\t\t\t\tborder-width: revert;\n\t\t\t\tborder-radius: 0;\n\t\t\t\tbottom: 51px;\n\t\t\t\tz-index: 2;\n\t\t\t\tright: 4px;\n\t\t\t\theight: 40px;\n\t\t\t\twidth: 40px;\n\t\t\t\tfont-size: 20px;\n\t\t\t}\n\n\t\t\t[data-feat-hideManualClearButtons] #inventory__close {\n\t\t\t\tbottom: 102px;\n\t\t\t}\n\n\t\t\t[data-feat-hideManualClearButtons] .inventory__content[data-tab="3"] {\n\t\t\t\tmargin-bottom: 41px;\n\t\t\t}\n\t\t`)}function alwaysShowSelfStatistics(t){window.__sbg_function_drawLeaderboard=async function(){var e;await t();const n={owned:"owned_points"};const i=((e=$("#leaderboard__term-select").val())===null||e===void 0?void 0:e.toString())||"";const o=(await window.__sbg_function_apiQuery("profile",{guid:$("#self-info__name").data("guid")})).response.data;const r=o[n[i]||i];const s=window.__sbg_function_jquerypassargs($("<li>"),"$1$ — $2$; $3$ $4$",$("<span>",{class:"profile-link"}).text(o.name).css("color",`var(--team-${o.team})`).attr("data-name",o.name).on("click",window.__sbg_function_openProfile),$("<span>").text(window.i18next.t("leaderboard.level",{count:o.level})).css("color",`var(--level-${o.level})`),...window.__sbg_function_takeUnits(r));const a=$("<ol>").addClass("leaderboard__list_self").attr("start",$("#leaderboard__place-pos").text()).append(s);$(".leaderboard__list_self").remove();$(".leaderboard__list").after(a)};setCSS(`\n\t\t\t.leaderboard__list_self {\n\t\t\t\tflex-shrink: 0;\n\t\t\t\tborder-top: 1px solid white;\n\t\t\t\tmargin: 0;\n\t\t\t\toverflow-y: auto;\n\t\t\t\tpadding-left: 3em;\n\t\t\t}\n\t\t`)}function restoreCUISort(){setCSS(`\n\t\t\t[data-feat-restoreCUISort] .inventory__content[data-tab="3"] ~ .inventory__controls > #eui-sort {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\n\t\t\t[data-feat-restoreCUISort] .inventory__content[data-tab="3"] ~ .inventory__controls > .sbgcui_refs-sort-button,\n\t\t\t[data-feat-restoreCUISort] .inventory__content[data-tab="3"] ~ .inventory__controls > .sbgcui_refs-sort-select {\n\t\t\t\tdisplay: block !important;\n\t\t\t}\n\t\t`)}function fixSortButton(t){setCSS(`\n\t\t\t.sbgcui_refs-sort-button {\n\t\t\t\tz-index: 100 !important;\n\t\t\t}\n\t\t`)}function quickRecycleAllRefs(t){setCSS(`\n\t\t\t.inventory__content[data-tab="3"] .inventory__item {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: row;\n\t\t\t}\n\n\t\t\t.inventory__content[data-tab="3"] .inventory__item-left {\n\t\t\t\torder: 0;\n\t\t\t}\n\n\t\t\t.inventory__content[data-tab="3"] .inventory__item-controls {\n\t\t\t\tflex-direction: row;\n\t\t\t}\n\n\t\t\t.inventory__content[data-tab="3"] .inventory__item-controls button {\n\t\t\t\twidth: 30px;\n\t\t\t\tmargin-left: 4px;\n\t\t\t}\n\n\t\t\t.inventory.popup .inventory__manage-amount[data-tab="3"] {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\t\t`);const e=t.get(0);e.getEventListeners("click").forEach((t=>e.removeEventListener("click",t)));$(document).on("click",".inventory__content",(async function(t){if(!t.target){return}if(!$(t.target).is(".inventory__ic-manage")){if($(t.target).is(".inventory__ic-view")){t.offsetX=0}e.getEventHandlers("click").map((e=>t.originalEvent&&e(t.originalEvent)));return}const n=$(t.target).parents(".inventory__item");const i=(JSON.parse(localStorage.getItem("inventory-cache")||"[]")||[]).find((t=>t.g==n.attr("data-guid")));if(!i){return}const o=$("<input />").addClass("inventory__ma-amount").val(i.a).css({display:"none"});Object.defineProperty(o.get(0),"reportValidity",{value:()=>true});n.append(o);n.attr("data-tab",i.t);await window.__sbg_function_deleteInventoryItem(n)}))}function makeInfoPopupSemiTransparent(){setCSS(`\n\t\t\t.info.popup {\n\t\t\t\tbackground-color: transparent;\n\t\t\t}\n\t\t`)}function alwaysShowSecondsForCoolDowns(){const t=90;const e=100;const n=60;window.__sbg_function_timeToString=function(t){return t>=e?window.i18next.t("units.min",{count:Math.floor(t/60)}):window.i18next.t("units.sec",{count:t})};setCSS(`\n\t\t\t#discover[data-remain] .discover-progress {\n\t\t\t\ttransform: scale(${n/t}, 1);\n\t\t\t\ttransform-origin: left;\n\t\t\t}\n\t\t`)}function increaseItemsFont(){setCSS(`\n\t\t\t.inventory__content:not([data-tab="3"]) {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\tflex-wrap: wrap;\n\t\t\t\tcounter-reset: section;\n\t\t\t}\n\n\t\t\t.inventory__content:not([data-tab="3"]) .inventory__item {\n\t\t\t\theight: calc((100% - 120px) / 5);\n\t\t\t\twidth: 50%;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t}\n\n\t\t\t.inventory__content:not([data-tab="3"]) .inventory__item-title {\n\t\t\t\theight: 2em;\n\t\t\t\tmargin-top: 0.8em;\n\t\t\t\tfont-size: 2em;\n\t\t\t}\n\n\t\t\t.inventory__content:not([data-tab="3"]) .inventory__item-descr {\n\t\t\t\tmargin-left: 0;\n\t\t\t\tmargin-top: -0.8em;\n\t\t\t\tfont-size: 1.3em !important;\n\t\t\t}\n\n\t\t\t.inventory__content:not([data-tab="3"]) .inventory__item-descr::first-letter {\n\t\t\t\tfont-size: 0;\n\t\t\t}\n\t\t`);const t=window.__sbg_variable_ItemTypes.get();t[1]="R";t[2]="X";t[3]="K";t[4]="Br"}function enlargeCoreSlots(){setCSS(`\n\t\t\t.i-stat__cores {\n\t\t\t\tpadding: 4px 0;\n\t\t\t}\n\n\t\t\t.i-stat__core {\n\t\t\t\tfont-size: 140%;\n\t\t\t}\n\t\t`)}function alignCloseButtonVertically(){setCSS(`\n\t\t\t.info.popup > .popup-close {\n\t\t\t\tmargin-top: -0.5em;\n\t\t\t\tmargin-bottom: calc(0.5em - 10px);\n\t\t\t}\n\t\t`)}function rearrangeButtons(){setCSS(`\n\t\t\t.i-stat .i-buttons {\n\t\t\t\t--discover-left: 0/6;\n\t\t\t\t--discover-right: 0/6;\n\n\t\t\t\t--discover-gap: 0.25em;\n\t\t\t\t--discover-border: 1.9px;\n\t\t\t\t--discover-parent: calc(0.9 * (100vw - 2 * var(--discover-border)) + 2 * var(--discover-gap));\n\t\t\t\t--discover-font-size: 1.1em;\n\n\t\t\t\t--discover-left-offset: calc(var(--discover-left) * (var(--discover-parent) + var(--discover-gap)));\n\t\t\t\t--discover-right-offset: calc(var(--discover-right) * (var(--discover-parent) + var(--discover-gap)));\n\n\t\t\t\t--discover-width: calc(var(--discover-parent) - var(--discover-left-offset) - var(--discover-right-offset));\n\n\t\t\t\t--discover-sibling-left-width: calc(var(--discover-left) * var(--discover-parent) - var(--discover-gap));\n\t\t\t\t--discover-sibling-right-width: calc(var(--discover-right) * var(--discover-parent) - var(--discover-gap));\n\n\t\t\t\t--discover-sibling-left-offset: calc(-1 * var(--discover-left-offset) - var(--discover-border));\n\t\t\t\t--discover-sibling-right-offset: calc(-1 * var(--discover-right-offset) - var(--discover-border));\n\n\t\t\t\t--discover-alt-button-width: calc(1/6 * (var(--discover-parent) - 2 * var(--discover-gap)) - 0.5 * var(--discover-border));\n\t\t\t}\n\n\t\t\t.i-buttons button {\n\t\t\t\tborder-width: 2px;\n\t\t\t}\n\n\t\t\t#discover {\n\t\t\t\tmargin-left: var(--discover-left-offset);\n\t\t\t\tmargin-right: var(--discover-right-offset);\n\t\t\t\twidth: var(--discover-width);\n\t\t\t}\n\n\t\t\t.sbgcui_no_loot,\n\t\t\t.sbgcui_no_refs {\n\t\t\t\twidth: var(--discover-alt-button-width);\n\t\t\t\tpadding: 0 calc(0.5 * var(--discover-gap));\n\t\t\t\tborder-color: currentColor !important;\n\t\t\t}\n\n\t\t\t.sbgcui_no_loot:before,\n\t\t\t.sbgcui_no_refs:before {\n\t\t\t\tmax-width: 1.5em;\n\t\t\t}\n\t\t`)}function hideCloseButton(){$("#draw").on("click",(t=>$(".draw-slider-buttons button").css({height:`${$(t.target).outerHeight()}px`})));setCSS(`\n\t\t\t[data-feat-hideCloseButton] .popup-close,\n\t\t\t[data-feat-hideCloseButton] #inventory__close,\n\t\t\t[data-feat-hideCloseButton] #draw-slider-close {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\n\t\t\t[data-feat-hideCloseButton] .draw-slider-buttons {\n\t\t\t\tpadding: 0 calc(5%);\n\t\t\t\tgap: 0.25em;\n\t\t\t}\n\n\t\t\t[data-feat-hideCloseButton] .draw-slider-buttons button {\n\t\t\t\twidth: calc(50% - 0.125em);\n\t\t\t\tmax-width: none !important;\n\t\t\t\tpadding: 6px;\n\t\t\t\tfont-size: 1.1em;\n\t\t\t}\n\n\t\t\t[data-feat-hideCloseButton] .i-stat .i-buttons {\n\t\t\t\tmargin: 0;\n\t\t\t}\n\t\t`)}function colorizeTimer(){rearrangeButtons();setCSS(`\n\t\t\t[data-feat-colorizeTimer] .i-stat .i-buttons {\n\t\t\t\t--discover-left: 1/6;\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover:after {\n\t\t\t\ttransform: none;\n\t\t\t\twidth: var(--discover-sibling-left-width);\n\t\t\t\tleft: var(--discover-sibling-left-offset);\n\t\t\t\theight: calc(100% + 2 * var(--discover-border));\n\t\t\t\ttop: calc(-1 * var(--discover-border));\n\t\t\t\tbox-sizing: border-box;\n\t\t\t\tline-height: 40px;\n\t\t\t\tborder: var(--discover-border) solid currentColor;\n\t\t\t\tcolor: var(--ingress-btn-border-color);\n\t\t\t\tborder-color: currentColor;\n\t\t\t\tcontent: ' ';\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time]:after {\n\t\t\t\tcontent: attr(data-time);\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain]:after {\n\t\t\t\tcontent: attr(data-time) ' #' attr(data-remain);\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time]:after {\n\t\t\t\tcolor: var(--ingress-btn-disabled-color);\n\t\t\t\tborder-color: var(--ingress-btn-disabled-accent-color);\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain]:after {\n\t\t\t\tbackground: none;\n\t\t\t\tborder-color: currentColor;\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain="4"]:after {\n\t\t\t\tcolor: var(--ingress-btn-border-color);\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain="3"]:after {\n\t\t\t\tcolor: white;\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain="2"]:after {\n\t\t\t\tcolor: yellow;\n\t\t\t}\n\n\t\t\t[data-feat-colorizeTimer] #discover[data-time][data-remain="1"]:after {\n\t\t\t\tcolor: orange;\n\t\t\t}\n\t\t`)}function hideRepairButton(){rearrangeButtons();setCSS(`\n\t\t\t[data-feat-hideRepairButton] #repair,\n\t\t\t[data-feat-hideRepairButton] #eui-repair {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\n\t\t\t[data-feat-hideRepairButton] .i-stat .i-buttons > button:not(#discover) {\n\t\t\t\twidth: calc(45% + 0.125em);\n\t\t\t}\n\t\t`)}function replaceSwipeWithButton(t){rearrangeButtons();t.hide();function createTouch(t){var e,n,i,o,r,s,a,l,c,u,d,g,p,h,f;const b=[{clientX:(e=t.clientX)!==null&&e!==void 0?e:0,clientY:(n=t.clientY)!==null&&n!==void 0?n:0,pageX:(o=(i=t.pageX)!==null&&i!==void 0?i:t.clientX)!==null&&o!==void 0?o:0,pageY:(s=(r=t.pageY)!==null&&r!==void 0?r:t.clientY)!==null&&s!==void 0?s:0,screenX:(l=(a=t.screenX)!==null&&a!==void 0?a:t.clientX)!==null&&l!==void 0?l:0,screenY:(u=(c=t.screenY)!==null&&c!==void 0?c:t.clientY)!==null&&u!==void 0?u:0,force:(d=t.force)!==null&&d!==void 0?d:0,identifier:(g=t.identifier)!==null&&g!==void 0?g:0,radiusX:(p=t.radiusX)!==null&&p!==void 0?p:1,radiusY:(h=t.radiusY)!==null&&h!==void 0?h:1,rotationAngle:(f=t.rotationAngle)!==null&&f!==void 0?f:0,target:t.target}];const m=new Set(b);return{touches:{length:m.size,item:t=>b[t],[Symbol.iterator]:m[Symbol.iterator]}}}function swipe(t,[e,n],[i,o]){const r=Math.random()*Number.MAX_SAFE_INTEGER;const s=createTouch({target:t,identifier:r,clientX:e,clientY:n});const a=createTouch({target:t,identifier:r,clientX:i,clientY:o});const l=t.getEventHandlers("touchstart").filter((t=>t.name==="touchStartHandler"));const c=t.getEventHandlers("touchmove").filter((t=>t.name==="touchMoveHandler"));const u=t.getEventHandlers("touchend").filter((t=>t.name==="touchEndHandler"));l.map((t=>t(s)));c.map((t=>t(s)));c.map((t=>t(a)));u.map((t=>t(a)))}const e=$("<button></button>").addClass("next").html('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="40" height="40" focusable="false"><path d="m15.5 0.932-4.3 4.38 14.5 14.6-14.5 14.5 4.3 4.4 14.6-14.6 4.4-4.3-4.4-4.4-14.6-14.6z"></path></svg>').on("click",(t=>{const e=document.querySelector(".info.popup");swipe(e,[200,0],[0,0]);t.stopPropagation();return false})).appendTo($("#discover"));new MutationObserver((n=>n.filter((({attributeName:t})=>t==="class")).map((()=>{e.prop("disabled",t.hasClass("sbgcui_hidden"))})))).observe(t.get(0),{attributes:true});setCSS(`\n\t\t\t.i-stat .i-buttons .next {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons {\n\t\t\t\t--discover-right: 1/6;\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons .next {\n\t\t\t\tdisplay: block;\n\t\t\t\tposition: absolute;\n\t\t\t\twidth: var(--discover-sibling-right-width);\n\t\t\t\tright: var(--discover-sibling-right-offset);\n\t\t\t\theight: calc(100% + 2 * var(--discover-border));\n\t\t\t\ttop: calc(-1 * var(--discover-border));\n\t\t\t\tcolor: var(--ingress-btn-color);\n\t\t\t\tbackground: linear-gradient(to top, var(--ingress-btn-glow-color) 0%, var(--ingress-btn-bg-color) 30%, var(--ingress-btn-bg-color) 70%, var(--ingress-btn-glow-color) 100%), var(--ingress-btn-bg-color);\n\t\t\t\tborder: 2px solid var(--ingress-btn-border-color);\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons .next:disabled {\n\t\t\t\tcolor: var(--ingress-btn-disabled-color);\n\t\t\t\tbackground: var(--ingress-btn-disabled-bg-color);\n\t\t\t\tborder-color: var(--ingress-btn-disabled-accent-color);\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons .next:active {\n\t\t\t\tfilter: saturate(2);\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons .next svg {\n\t\t\t\theight: 16px;\n\t\t\t\tposition: relative;\n\t\t\t\ttop: 2px;\n\t\t\t}\n\n\t\t\t[data-feat-replaceSwipeWithButton] .i-stat .i-buttons .next svg path {\n\t\t\t\tfill: currentColor;\n\t\t\t}\n\t\t`)}function showFeatureToggles(){const t={info:$(".info.popup .i-image-box"),inventory:$(".inventory.popup")};Object.values(t).forEach((t=>$("<div></div>").addClass("i-buttons i-feature-toggles").appendTo(t)));const e=[{container:"info",title:"CLS",feature:a.get(hideCloseButton)},{container:"info",title:"REP",feature:a.get(hideRepairButton)},{container:"info",title:"SWP",feature:a.get(replaceSwipeWithButton)},{container:"info",title:"TMR",feature:a.get(colorizeTimer)},{container:"inventory",title:"CUI",feature:a.get(restoreCUISort)},{container:"inventory",title:"BUT",feature:a.get(moveRerefenceButtonsDown)},{container:"inventory",title:"CLR",feature:a.get(hideManualClearButtons)}];for(const{container:n,title:i,feature:o}of e){const e=$("<button></button>").html(i).toggleClass("off",!o.isEnabled()).appendTo(t[n].find(".i-buttons"));e.on("click",(()=>{const t=o.toggle();e.toggleClass("off",!t)}))}setCSS(`\n\t\t\t.i-feature-toggles {\n\t\t\t\tposition: absolute !important;\n\t\t\t\tleft: 0;\n\t\t\t\tbottom: 0;\n\t\t\t\tjustify-content: flex-start;\n\t\t\t\tdirection: ltr;\n\t\t\t}\n\n\t\t\t.i-feature-toggles button {\n\t\t\t\twidth: auto;\n\t\t\t\tposition: relative;\n\t\t\t\tz-index: 1;\n\t\t\t\tfont-size: 0.85em;\n\t\t\t\tmin-height: 0px;\n\t\t\t\tline-height: 1;\n\t\t\t}\n\n\t\t\t.i-feature-toggles button.off {\n\t\t\t\tfilter: saturate(0.15);\n\t\t\t}\n\t\t`)}function selectTargetPointByClick(){(t=>{window.__sbg_function_showInfo=function(e){if(!$("#draw-slider").is(":visible")){t(e)}else{const t=$(`#draw-slider li[data-point="${e}"]`);if(t.length>0){window.__sbg_variable_draw_slider.get().go(t.index())}}}})(window.__sbg_function_showInfo)}function highlightSelectedTargetPoint(){const t=addLayer("highlights","points");(e=>{window.__sbg_variable_temp_lines_source.get().clear=function(n){e.call(this,n);t.getSource().clear(n)}})(window.__sbg_variable_temp_lines_source.get().clear);(e=>{window.__sbg_function_manageDrawing=function(n){e(n);const i=window.__sbg_variable_temp_lines_source.get().getFeatures()[0];const o=i.getGeometry().flatCoordinates;const r=new window.ol.Feature({geometry:new window.ol.geom.Circle([o.slice(o.length-2)],16)});const s=new window.ol.style.Style({stroke:new window.ol.style.Stroke({color:"#F80",width:3})});r.setStyle(s);t.getSource().addFeature(r)}})(window.__sbg_function_manageDrawing)}function matchDrawSliderButtons(t){$("#draw").on("click",(e=>{var n,i;t.css({bottom:`${$(window).height()-((n=$(e.target).offset())===null||n===void 0?void 0:n.top)-$("#draw").outerHeight()}px`});t.find(".draw-slider-buttons").css({padding:`0 ${(i=$(e.target).offset())===null||i===void 0?void 0:i.left}px`})}));setCSS(`\n\t\t\t.draw-slider-wrp {\n\t\t\t\ttransform: translate(-50%, 0);\n\t\t\t\ttop: auto;\n\t\t\t}\n\n\t\t\t.sbgcui_drawslider_sort {\n\t\t\t\tposition: static;\n\t\t\t\ttop: auto;\n\t\t\t\twidth: auto;\n\t\t\t}\n\t\t`)}function enableOldWebViewCompatibility(){setCSS(`\n\t\t\t@media (max-width: 425px) {\n\t\t\t\t.popup.pp-center {\n\t\t\t\t\ttop: 0 !important;\n\t\t\t\t\tleft: 0 !important;\n\t\t\t\t\ttransform: none !important;\n\t\t\t\t}\n\t\t\t}\n\t\t`)}class Builder{constructor(t){this.features={};this.points={};this.pointStyles={};this.lines=new CoordsMap;this.regions=new CoordsMap;this.linesMap=new CoordsMap;this.regionsMap=new CoordsMap;this.drawTeam=4;this.maxDrawAttempts=3;this.initCSS();this.initTeam();this.initLayers();const e=this.initButtons(t);this.initFeatures(e);this.initData();this.initMapClick();this.initStates();this.initHelpPopup();this.initRoutePopup();this.initCopyPaste();Object.defineProperty(window,"builder",{value:this})}initCSS(){setCSS(`\n\t\t\t\t.builder {\n\t\t\t\t\tposition: relative;\n\t\t\t\t\tmargin-top: 1em;\n\t\t\t\t\tpointer-events: all;\n\t\t\t\t\twidth: 120px;\n\t\t\t\t}\n\n\t\t\t\t.sbgcui_settings ~ .builder {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\n\t\t\t\t.sbgcui_settings.sbgcui_hidden ~ .builder {\n\t\t\t\t\tdisplay: block;\n\t\t\t\t}\n\n\t\t\t\t.builder button {\n\t\t\t\t\tdisplay: block;\n\t\t\t\t\tmargin-bottom: 0.25em;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\n\t\t\t\t.builder button.active {\n\t\t\t\t\tbackground: white;\n\t\t\t\t\tcolor: #414141;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t}\n\t\t\t`)}initTeam(){const t=$("#self-info__name").attr("style");if(t){const e=t.match(/team-(\d+)/);if(e){this.ownTeam=parseInt(e[1])}}window.__sbg_variable_TeamColors.get().push({fill:"#FF880030",stroke:"#F80"})}initLayers(){this.addLayer("lines_built","lines");this.addLayer("regions_built","regions");this.addLayer("regions_shared","regions");u.get("lines").getSource().on("addfeature",(t=>{this.addLine(t.feature,this.getLineCoords(t.feature),{mine:false})}));u.get("regions").getSource().on("addfeature",(t=>{this.addRegion(t.feature,this.getRegionCoords(t.feature),{mine:false})}));u.get("lines").getSource().getFeatures().forEach((t=>{this.addLine(t,this.getLineCoords(t),{mine:false})}));u.get("regions").getSource().getFeatures().forEach((t=>{this.addRegion(t,this.getRegionCoords(t),{mine:false})}))}addLayer(t,e){const n=addLayer(t,e);u.set(t,n)}initButtons(t){return $("<div></div>").addClass("builder").appendTo(t)}initFeatures(t){const i={home:false,allLines:true,builder:false,undo:false,clear:false,route:false,copy:false,paste:false,help:true};const o={home:this.setHome,allLines:this.toggleAllLines,builder:this.toggle,undo:this.undo,clear:this.clear,route:this.printRoute,copy:this.copy,paste:this.paste,help:this.showHelp};for(const r of e){this.features[r]=new BuilderFeature({name:r,buttonContainer:t,initialState:i[r],action:o[r],label:n.builder.buttons[r],builder:this})}}initData(){this.data=new BuilderData(this);this.data.load()}initMapClick(){const t=window.__sbg_variable_map.get().getListeners("click")[0];const extendedMapClick=e=>{if(this.features.builder.getState()){this.mapClick(e)}else{t(e)}};window.__sbg_variable_map.get().un("click",t);window.__sbg_variable_map.get().on("click",extendedMapClick)}mapClick(t){window.__sbg_variable_map.get().forEachFeatureAtPixel(t.pixel,(async(t,e)=>{log(`BUILDER click layer: ${e.getProperties().name}`);if(e.getProperties().name!=="points"){return}const n=t;const i=this.getPointCoords(n);this.setPointDrawing(n,true);if(!this.startPoint){log(`BUILDER clicked: start coords: ${JSON.stringify(i)}`);this.startPoint=n;return}const o=n;if(o.getId()===this.startPoint.getId()){return}log(`BUILDER clicked: end coords: ${JSON.stringify(i)}`);const r=await LineData.load([this.startPoint,o],this);const s=this.buildLine(r);this.setPointDrawing(this.startPoint,false);this.setPointDrawing(o,false);if(s){this.startPoint=undefined}}))}getNPoints(){const t=window.__sbg_variable_map.get().getView().getZoom();if(t>10){return 5}if(t>7){return 25}return 50}setPointDrawing(t,e){if(e){this.pointStyles[t.getId()]=t.getStyle();t.setStyle(window.__sbg_variable_FeatureStyles.get().POINT(t.getGeometry().flatCoordinates,this.drawTeam,1,true))}else{t.setStyle(this.pointStyles[t.getId()])}}initStates(){this.toggleAllLines(!this.features.allLines.getState());this.toggle(!this.features.builder.getState());this.data.updateStates()}initHelpPopup(){const t=`\n\t\t\t\t<h3>${n.builder.help.title.toString()}</h3>\n\t\t\t\t<b>${n.builder.help.buttons.toString()}:</b>\n\t\t\t\t<ul>\n\t\t\t\t${Object.values(n.builder.buttons).map((t=>`<li><b>${t.title.toString()}</b> - ${t.description.toString()}</li>`)).join("\n")}\n\t\t\t\t</ul>\n\t\t\t\t<b>${n.builder.issues.title.toString()}:</b>\n\t\t\t\t<ul>\n\t\t\t\t${n.builder.issues.list.map((t=>`<li>${t.toString()}</li>`)).join("\n")}\n\t\t\t\t</ul>\n\t\t\t`;createPopup("help").prepend(t)}initRoutePopup(){const t=$("<textarea></textarea>").on("click",(t=>t.stopPropagation())).on("keydown",(t=>t.stopPropagation()));createPopup("route").prepend(t)}initCopyPaste(){$(document).on("keydown",(t=>{if(t.ctrlKey){switch(t.key){case"c":return this.data.copy(true);case"v":return this.data.paste(true)}}}))}getCoords(t){const e=window.ol.proj.toLonLat(t);return e.map((t=>parseFloat(t.toFixed(6))))}getFlatCoordinates(t){return window.ol.proj.fromLonLat(t)}getArcFlatCoordinates(t){const e=[];for(let n=1;n<t.length;n++){const i=window.turf.greatCircle(t[n-1],t[n],{npoints:this.getNPoints()});e.push(i.geometry.coordinates)}return e.flat().map((t=>this.getFlatCoordinates(t)))}getPointCoords(t){const{flatCoordinates:e}=t.getGeometry();return this.getCoords(e)}getLineCoords(t){const{flatCoordinates:e}=t.getGeometry();const n=this.getCoords([e[0],e[1]]);const i=this.getCoords([e[e.length-2],e[e.length-1]]);return this.createLineCoords(n,i)}getRegionCoords(t){const{flatCoordinates:e}=t.getGeometry();const n=this.getCoords([e[0],e[1]]);const i=this.getCoords([e[e.length*1/3],e[e.length*1/3+1]]);const o=this.getCoords([e[e.length*2/3],e[e.length*2/3+1]]);return this.createRegionCoords(n,i,o)}createLineCoords(...t){const e=t.sort((function(t,e){return t[0]-e[0]||t[1]-e[1]}));return[e[0],e[1]]}createRegionCoords(...t){const e=t.sort((function(t,e){return t[0]-e[0]||t[1]-e[1]}));return[e[0],e[1],e[2],e[0]]}addLine(t,e,{mine:n}){if(![this.ownTeam,this.drawTeam].includes(t.getProperties().team)){return}this.linesMap.create(e[0],[]).push({coords:e[1],mine:n});this.linesMap.create(e[1],[]).push({coords:e[0],mine:n});this.lines.set(e,t);this.checkRegions(e,{mine:n})}addRegion(t,e,{mine:n}){if(![this.ownTeam,this.drawTeam].includes(t.getProperties().team)){return}this.regionsMap.create([e[0],e[1]],[]).push({region:t,mine:n});this.regionsMap.create([e[0],e[2]],[]).push({region:t,mine:n});this.regionsMap.create([e[1],e[2]],[]).push({region:t,mine:n});this.regions.set(e,t)}buildLine({linePoints:t,lineCoords:e},n=0){const i=`line.built.${(new Date).getTime()}`;const o="lines_built";const r=this.lines.get(e);if(r){if(this.features.allLines.getState()||r.getProperties().mine){log(`BUILDER buildLine cancelled, already exists, coords: ${JSON.stringify(e)}`);return}else{log(`BUILDER buildLine duplicated, layer: ${o}, coords: ${JSON.stringify(e)}`)}}else{log(`BUILDER buildLine, layer: ${o}, attempt: ${n}, coords: ${JSON.stringify(e)}`)}const s=this.getArcFlatCoordinates(e);const a=new window.ol.Feature({geometry:new window.ol.geom.LineString(s)});a.setId(i);a.setProperties({team:this.drawTeam,mine:true});a.setStyle(new window.ol.style.Style({stroke:new window.ol.style.Stroke({color:window.__sbg_variable_TeamColors.get()[this.drawTeam].stroke,width:2})}));const l=u.get(o).getSource();const c=l.getFeatures().length;l.addFeature(a);if(l.getFeatures().length===c){n++;log(`BUILDER buildLine failed, attempt: ${n}, coords: ${JSON.stringify(e)}`);if(n>=this.maxDrawAttempts){return}this.buildLine({linePoints:t,lineCoords:e},n);return}this.addLine(a,e,{mine:true});this.data.add({linePoints:t,lineCoords:e});return a}buildRegion(t,e,n=0){const i=`region.built.${(new Date).getTime()}`;const o=e?"regions_shared":"regions_built";const r=this.createRegionCoords(...t);const s=this.regions.get(r);if(s){if(!this.features.allLines.getState()&&!e&&(!s.getProperties().mine||s.getProperties().shared)){log(`BUILDER buildRegion duplicated, layer: ${o}, coords: ${JSON.stringify(r)}`)}else{log(`BUILDER buildRegion cancelled, already exists, coords: ${JSON.stringify(r)}`);return}}else{log(`BUILDER buildRegion, layer: ${o}, coords: ${JSON.stringify(r)}`)}const a=this.getArcFlatCoordinates(r);const l=new window.ol.Feature({geometry:new window.ol.geom.Polygon([a])});l.setId(i);l.setProperties({team:this.drawTeam,mine:true,shared:e});l.setStyle(new window.ol.style.Style({fill:new window.ol.style.Fill({color:window.__sbg_variable_TeamColors.get()[this.drawTeam].fill})}));const c=u.get(o);const d=c.getSource();const g=d.getFeatures().length;d.addFeature(l);if(d.getFeatures().length===g){n++;log(`BUILDER buildRegion failed, attempt: ${n}, coords: ${JSON.stringify(r)}`);if(n>=this.maxDrawAttempts){return}this.buildRegion(t,e,n);return}this.addRegion(l,r,{mine:true});return l}checkRegions(t,{mine:e}){const n=this.linesMap.get(t[0]);const i=this.linesMap.get(t[1]);if(!n||!i){return}for(const o of n){for(const n of i){if(o.coords[0]===n.coords[0]&&o.coords[1]===n.coords[1]){if(e||o.mine||n.mine){const i=!(e&&o.mine&&n.mine);this.buildRegion([...t,o.coords],i)}}}}}async setHome(t){if(t){if(!confirm(n.builder.messages.deleteHome.toString())){return false}delete localStorage.homeCoords}else{if(!confirm(n.builder.messages.setHome.toString())){return false}localStorage.homeCoords=JSON.stringify(window.__sbg_variable_map.get().getView().getCenter())}return true}async toggleAllLines(t){u.get("lines").setVisible(!t);u.get("regions").setVisible(!t);u.get("regions_shared").setVisible(!t&&this.features.builder.getState());return true}async toggle(t){u.get("lines_built").setVisible(!t);u.get("regions_built").setVisible(!t);u.get("regions_shared").setVisible(!t&&this.features.allLines.getState());this.features.builder.setState(!t);this.data.updateStates()}async undo(t){if(!t){return false}const{lineCoords:e}=this.data.pop()||{};if(e){const t=this.lines.get(e);if(!t){log(`undo: line not found, coords: ${JSON.stringify(e)}`);return false}u.get("lines_built").getSource().removeFeature(t);this.lines.deleteMine(e);const n=this.regionsMap.get(e);if(n){n.filter((({mine:t})=>t)).forEach((({region:t})=>{u.get("regions_built").getSource().removeFeature(t);u.get("regions_shared").getSource().removeFeature(t);this.regions.deleteMine(this.getRegionCoords(t))}))}}return false}async clear(t){if(!t){return false}u.get("lines_built").getSource().clear();u.get("regions_built").getSource().clear();u.get("regions_shared").getSource().clear();this.data.clear();this.lines.clearMine();this.regions.clearMine();this.linesMap.clearMine();this.regionsMap.clearMine();this.startPoint=undefined;return false}async printRoute(t){if(!t){return false}const e=this.data.getRoute();$(".route.popup").find("textarea").val(e).end().removeClass("hidden")}async copy(t){return this.data.copy(t)}async paste(t){return this.data.paste(t)}async showHelp(t){$(".help").removeClass("hidden")}}class BuilderFeature{constructor({name:t,action:e,initialState:n,label:i,buttonContainer:o,builder:r}){this.name=t;this.action=e.bind(r);this.button=this.createButton(i,o);this.initState(n)}getState(){return this.state.value}setState(t){this.state.value=t}setButtonState(){this.button.toggleClass("active",this.state.value)}initState(t){const e=this.loadState(t);this.state=new Proxy({value:e},{get:(t,e)=>t[e],set:(t,e,n)=>{const i=this.getStorageKey();localStorage[i]=n?"1":"0";t[e]=n;this.setButtonState();return true}});this.setButtonState()}loadState(t){const e=this.getStorageKey();const n=localStorage[e];return n===undefined||n.length===0?t:n==="1"}getStorageKey(){return`sbg-plus-state-${this.name}`}createButton(t,e){const n=$("<button></button>").html(t.title.toString().toUpperCase()).attr("title",t.description.toString()).appendTo(e);n.on("click",(async()=>{if(await this.action(this.state.value)){this.state.value=!this.state.value}}));return n}}class BuilderData{constructor(t){this.storageKey="builderData";this.builder=t;this.data=[]}add(t){this.data.push(t);this.updateStates();this.save()}pop(){const t=this.data.pop();this.updateStates();this.save();return t}clear(){this.data=[];this.updateStates();this.save()}count(){return this.data.length}updateStates(){const t=this.builder.features.builder.getState();const e=this.data.length>0;this.builder.features.undo.setState(t&&e);this.builder.features.clear.setState(t&&e);this.builder.features.route.setState(t&&e);this.builder.features.copy.setState(t&&e);this.builder.features.paste.setState(t)}save(){localStorage[this.storageKey]=JSON.stringify(BuilderData.pack(this.data));log(`BUILDER saved lines: ${this.data.length}`)}load(){const t=localStorage[this.storageKey];if(t){this.set(t)}}set(t){const e=this.parse(t);if("error"in e){alert(e.error.toString());return}const n=BuilderData.unpack(e.pack);for(const t of n){this.builder.buildLine(t)}}static pack(t){const e=new CoordsMap;const n=[];for(const{lineCoords:i,linePoints:o}of t){n.push(i);o.forEach((t=>{e.set(t.coords,t)}))}return{points:e.getData(),lines:n}}static unpack(t){const e=[];const n=new CoordsMap(t.points);for(const i of t.lines){const t=[n.get(i[0]),n.get(i[1])];const o=new LineData(t,i);e.push(o)}return e}parse(t){let e;try{e=JSON.parse(t)}catch(t){return{error:n.builder.validationErrors.json}}const i=new BuilderDataPackValidator(n.builder.validationErrors);if(!i.validate(e)){return{error:i.getError()}}return{pack:e}}async copy(t){if(!t){return false}await navigator.clipboard.writeText(JSON.stringify(BuilderData.pack(this.data)));alert(n.builder.messages.copied.toString())}async paste(t){if(!t){return false}const e=await navigator.clipboard.readText();if(!e.trim()){alert(n.builder.validationErrors.empty.toString())}this.set(e)}getRoute(){return this.data.map((t=>t.linePoints.map((t=>t.title)).join(" => "))).join("\n")}}class LineData{constructor(t,e){this.linePoints=t;this.lineCoords=e}static async load(t,e){const n=t.map((t=>PointData.resolve(t,e)));const i=await Promise.all(n);const o=e.createLineCoords(i[0].coords,i[1].coords);return new LineData(i,o)}}class PointData{constructor(){}static async resolve(t,e){const n=new PointData;n.guid=t.getId();n.title=await PointData.getPointTitle(n.guid,e.points);n.coords=e.getPointCoords(t);return n}static async getPointTitle(t,e){if(!e[t]){const{response:n}=await window.__sbg_function_apiQuery("point",{guid:t});e[t]=n.data.t}return e[t]}}const d=typeof{};class BuilderDataPackValidator{constructor(t){this.validationErrors=t}validate(t){return this.checkObject(t)&&this.checkObjectProperties(t)&&this.checkPoints(t.points)&&this.checkPointsCoords(t.points)&&this.checkLines(t.lines)&&this.checkLinesCoords(t.lines)}isObject(t,e){if(Object.keys(t).length!==Object.keys(e).length){return false}for(const n in e){const i=e[n];if(!(n in t&&typeof t[n]===i)){return false}}return true}isArray(t,e,n){if(!Array.isArray(t)){return false}if(t.length!==e){return false}for(const e of t){if(typeof e!==n){return false}}return true}checkObject(t){if(typeof t!=="object"){this.validationError=this.validationErrors.object;return false}return true}checkObjectProperties(t){if(!this.isObject(t,{points:"object",lines:"object"})){this.validationError=this.validationErrors.objectProperties;return false}return true}checkPoints(t){if(Object.values(t).filter((t=>!this.isObject(t,{guid:"string",title:"string",coords:"object"}))).length>0){this.validationError=this.validationErrors.pointProperties;return false}return true}checkPointsCoords(t){if(Object.values(t).map((t=>t.coords)).filter((t=>!this.isArray(t,2,"number"))).length>0){this.validationError=this.validationErrors.pointCoords;return false}return true}checkLines(t){if(!Array.isArray(t)||t.filter((t=>!this.isArray(t,2,"object"))).length>0){this.validationError=this.validationErrors.lines;return false}return true}checkLinesCoords(t){if(t.flat().filter((t=>!this.isArray(t,2,"number"))).length>0){this.validationError=this.validationErrors.linesCoords;return false}return true}getError(){return this.validationError}}class CoordsMap{constructor(t={}){this.data=t}stringifyKey(t){return typeof t==="string"?t:t.map((t=>Array.isArray(t)?t.join(","):t)).join(",")}getData(){return this.data}get(t){return this.data[this.stringifyKey(t)]}set(t,e){this.data[this.stringifyKey(t)]=e}create(t,e){if(!this.has(t)){this.set(t,e)}return this.get(t)}has(t){return this.stringifyKey(t)in this.data}forEach(t){for(const e in this.data){t(this.data[e],e)}}deleteMine(t){const e=this.stringifyKey(t);const n=this.data[e];if(n instanceof window.ol.Feature&&n.getProperties().mine){delete this.data[e]}if(Array.isArray(n)){const t=n.filter((t=>!t.mine));if(t.length===0){delete this.data[e]}else{this.data[e]=t}}}clearMine(){Object.keys(this.data).forEach((t=>{this.deleteMine(t)}))}}class SettingsPopup{constructor(){this.sections={};this.checkboxes={};this.render();Object.keys(a.groups).map((t=>{const e=a.groups[t].filter((t=>t.isAvailable()));if(e.length===0&&t!=="custom"){return}this.addGroup(t);e.map((t=>this.addFeature(t)))}));a.on("add",(t=>this.addFeature(t)));a.on("check",((t,e)=>this.check(t,e)))}render(){const t=$(".settings");const e=createPopup("sbg-plus-settings",{roundClose:false}).appendTo(t);this.container=$("<div></div>").addClass("settings-content");const o=$("<h3></h3>").text(n.settings.title.toString());e.prepend(o,this.container);const r=$("<button></button>").text(n.save.toString()).on("click",(()=>{i.save();window.location.reload()}));const s=$("<button></button>").addClass("popup-button-secondary").text(n.settings.logs.toString()).on("click",(()=>{copyLogs()}));const a=$("<button></button>").addClass("popup-button-secondary").text(n.settings.advanced.toString()).on("click",(()=>{a.toggleClass("popup-button-secondary");e.toggleClass("advanced")}));e.find(".buttons").prepend(r);e.find(".buttons").append(s);e.find(".buttons").append(a);const l=$("<button></button>").addClass("settings-section__button").text(n.settings.button.toString()).on("click",(()=>e.removeClass("hidden")));const c=this.renderSetting(true,n.settings.title,l);$(".settings .settings-section:first .settings-section__item:first").before(c);const u=$("<span></span>").text(`v${window.__sbg_plus_version}`);const d=this.renderSetting(true,n.settings.version,u);$('.settings [data-i18n="settings.about.version"]').parent().after(d)}addGroup(t){const e=o[t];const n=$("<h4></h4>").text(new Label(e).toString());const i=$("<div></div>").addClass("settings-section").append(n);this.sections[t]=i;this.container.append(i)}addFeature(t){const e=this.renderFeatureCheckbox(t);const n=this.renderSetting(t.isSimple(),e,t.label);this.sections[t.group].find("h4").before(n);this.checkboxes[t.key]=e}check(t,e){i.setFeature(t.key,e);this.checkboxes[t.key].prop("checked",e)}renderSetting(t,...e){const n=$("<label></label>").addClass("settings-section__item").toggleClass("simple",t);for(const t of e){const e=t instanceof Label?$("<span></span>").text(t.toString()):t;n.append(e)}return n}renderFeatureCheckbox(t){return $('<input type="checkbox" />').prop("checked",t.isEnabled()).on("change",(e=>{t.setEnabled(e.target.checked)}))}}main()})();